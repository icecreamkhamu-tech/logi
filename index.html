<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messenger App</title>
<style>
body{font-family:Arial;background:#f0f0f0;margin:0;padding:0;text-align:center}
.container{background:#fff;margin:30px auto;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);width:90%;max-width:400px}
input,button{width:90%;padding:10px;margin:8px 0;border-radius:5px;border:1px solid #ccc}
button{background:#4CAF50;color:#fff;border:none;cursor:pointer}
.hidden{display:none}
.user{padding:10px;margin:5px;background:#fff;border-radius:5px;cursor:pointer}
.user:hover{background:#eee}
.message{padding:8px;border-radius:5px;margin:5px;width:fit-content;max-width:70%}
.sent{background:#DCF8C6;margin-left:auto}
.received{background:#eee;margin-right:auto}
#chatArea{height:300px;overflow-y:auto;background:#fff;padding:10px;margin-top:10px;border-radius:8px}
#suggestions{background:#fff;max-height:200px;overflow-y:auto;}
.suggestionItem{padding:8px;border-bottom:1px solid #ddd;cursor:pointer;}
.suggestionItem:hover{background:#eee;}
.conversationItem{padding:10px;border-bottom:1px solid #ddd;cursor:pointer;}
.conversationItem:hover{background:#eee;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h2>Login</h2>
  <input id="loginEmail" type="email" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <a href="#" onclick="showPage('forgotPage')">Forgot Password?</a>
  <a href="#" onclick="showPage('signupPage')">Create Account</a>
</div>

<!-- SIGNUP -->
<div id="signupPage" class="container hidden">
  <h2>Sign Up</h2>
  <input id="name" placeholder="Full Name">
  <input id="mobile" placeholder="Mobile Number">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <input id="dob" type="date">
  <button onclick="signup()">Sign Up</button>
  <a href="#" onclick="showPage('loginPage')">Back to Login</a>
</div>

<!-- FORGOT PASSWORD -->
<div id="forgotPage" class="container hidden">
  <h2>Reset Password</h2>
  <input id="forgotEmail" type="email" placeholder="Enter Email">
  <button onclick="resetPass()">Send Reset Link</button>
  <a href="#" onclick="showPage('loginPage')">Back to Login</a>
</div>

<!-- MAIN PAGE -->
<div id="mainPage" class="container hidden">
  <h2>Messenger</h2>
  <input type="text" id="searchBox" placeholder="Search user..." oninput="suggestUsers()" onkeydown="handleEnter(event)">
  <div id="suggestions"></div>
  <h3>Conversations</h3>
  <div id="conversationList"></div>
</div>

<!-- CHAT PAGE -->
<div id="chatPage" class="container hidden">
  <button onclick="backToMain()">â¬… Back</button>
  <h3 id="chatWith"></h3>
  <div id="chatArea"></div>
  <input id="messageInput" placeholder="Type message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, setDoc, doc, collection, query, getDocs, addDoc, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDA3y67A-d77q1zwh5_GHtYundQyudvbdc",
  authDomain: "freefire-7f9b7.firebaseapp.com",
  projectId: "freefire-7f9b7",
  storageBucket: "freefire-7f9b7.appspot.com",
  messagingSenderId: "69091172437",
  appId: "1:69091172437:web:fd82e4ded5d5252bf4b4dc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let selectedUser = null;

window.showPage = (id) => {
  document.querySelectorAll('.container').forEach(e=>e.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
};

onAuthStateChanged(auth, (user)=>{
  if(user){
    currentUser = user;
    showPage('mainPage');
    loadConversations();
  }else{
    showPage('loginPage');
  }
});

window.signup = async ()=>{
  const name = nameEl.value, mobile = mobileEl.value, email = emailEl.value, pass = passwordEl.value, dob = dobEl.value;
  try{
    const res = await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,"users",res.user.uid),{uid:res.user.uid,name,mobile,email,dob});
    alert("Account created!");
    showPage('loginPage');
  }catch(e){alert(e.message);}
};
const nameEl=document.getElementById("name"),mobileEl=document.getElementById("mobile"),emailEl=document.getElementById("email"),passwordEl=document.getElementById("password"),dobEl=document.getElementById("dob");

window.login = async ()=>{
  const email=document.getElementById("loginEmail").value,pass=document.getElementById("loginPass").value;
  try{
    await signInWithEmailAndPassword(auth,email,pass);
    showPage('mainPage');
    loadConversations();
  }catch(e){alert(e.message);}
};

window.resetPass = async ()=>{
  const email=document.getElementById("forgotEmail").value;
  try{
    await sendPasswordResetEmail(auth,email);
    alert("Reset link sent!");
  }catch(e){alert(e.message);}
};

window.logout = ()=> signOut(auth);

// Suggest users
window.suggestUsers = async ()=>{
  const term = document.getElementById("searchBox").value.toLowerCase();
  const list = document.getElementById("suggestions");
  list.innerHTML="";
  if(term==="") return;
  const q = query(collection(db,"users"),orderBy("name"));
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const u = docSnap.data();
    if(u.name && u.name.toLowerCase().includes(term) && u.uid !== currentUser.uid){
      const div=document.createElement("div");
      div.className="suggestionItem";
      div.textContent=u.name;
      div.onclick=()=>openChat(u);
      list.appendChild(div);
    }
  });
};

// Handle enter press
function handleEnter(e){
  if(e.key==="Enter") searchUsers();
}

// Load conversation list
async function loadConversations(){
  const convList = document.getElementById("conversationList");
  convList.innerHTML="";
  const q = query(collection(db,"users"),orderBy("name"));
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const u = docSnap.data();
    if(u.uid !== currentUser.uid){
      const div=document.createElement("div");
      div.className="conversationItem";
      div.textContent=u.name;
      div.onclick=()=>openChat(u);
      convList.appendChild(div);
    }
  });
}

// Open chat
async function openChat(u){
  selectedUser=u;
  showPage('chatPage');
  document.getElementById("chatWith").textContent="Chat with "+u.name;
  const chatId = currentUser.uid < u.uid ? currentUser.uid+"_"+u.uid : u.uid+"_"+currentUser.uid;
  const chatArea=document.getElementById("chatArea");
  chatArea.innerHTML="";
  const msgRef=collection(db,"chats",chatId,"messages");
  const q=query(msgRef,orderBy("timestamp"));
  onSnapshot(q,(snap)=>{
    chatArea.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="message "+(m.senderId===currentUser.uid?"sent":"received");
      div.textContent=m.message;
      chatArea.appendChild(div);
    });
    chatArea.scrollTop=chatArea.scrollHeight;
  });
}

// Send message
window.sendMessage=async()=>{
  const input=document.getElementById("messageInput");
  if(!selectedUser||!input.value.trim()) return;
  const chatId=currentUser.uid<selectedUser.uid?currentUser.uid+"_"+selectedUser.uid:selectedUser.uid+"_"+currentUser.uid;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    senderId:currentUser.uid,
    message:input.value,
    timestamp:serverTimestamp()
  });
  input.value="";
};

// Back to main
function backToMain(){
  showPage('mainPage');
}
</script>
</body>
</html>
